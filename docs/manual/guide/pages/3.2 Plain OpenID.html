<html>
    <head>
        <meta http-equiv="Content-type" content="text/html; charset=utf-8"/>
        <title>3.2 Plain OpenID</title>
        <link rel="stylesheet" href="../css/main.css" type="text/css" media="screen" title="Ref" charset="utf-8"/>
    </head>
    <body class="body">
    In the previous tutorial we went through two workflows to allow linking OpenIDs to local accounts. Another option is to only support OpenID logins but not associate them with local accounts. This might be useful if you want to allow people to perform some basic actions like clicking Like and Don't Like buttons, adding comments, etc.<p class="paragraph"/>To support this, rather than showing the registration page when an authenticated OpenID user is redirected to your controller, you could just create an <code>Authentication</code> for them with dummy information. Recall that the minimum requirements to populate a <code>UserDetails</code> instance are the username, the status booleans (enabled, locked out, etc.) and one or more granted authorities. You could emulate a basic application user by using their OpenID as the username, setting all statuses to <code>true</code>, and granting them a virtual role, e.g. <code>ROLE_OPENID</code>.<p class="paragraph"/>Edit the generated <code>grails-app/controllers/OpenIdController.groovy</code> and replace the existing <code>createAccount</code> action with this:<p class="paragraph"/><div class="code"><pre>def createAccount = &#123;<p class="paragraph"/>   <span class="java&#45;object">String</span> openId = session&#91;OIAFH.LAST_OPENID_USERNAME&#93;
   <span class="java&#45;keyword">if</span> (!openId) &#123;
      flash.error = 'Sorry, an OpenID was not found'
      redirect uri: config.failureHandler.defaultFailureUrl
      <span class="java&#45;keyword">return</span>
   &#125;<p class="paragraph"/>   def user = <span class="java&#45;keyword">new</span> GrailsUser(openId, 'password', <span class="java&#45;keyword">true</span>, <span class="java&#45;keyword">true</span>,
         <span class="java&#45;keyword">true</span>, <span class="java&#45;keyword">true</span>, &#91;<span class="java&#45;keyword">new</span> GrantedAuthorityImpl('ROLE_OPENID')&#93;, 0)<p class="paragraph"/>   SCH.context.authentication = <span class="java&#45;keyword">new</span> UsernamePasswordAuthenticationToken(
         user, 'password', user.authorities)<p class="paragraph"/>   session.removeAttribute OIAFH.LAST_OPENID_USERNAME
   session.removeAttribute OIAFH.LAST_OPENID_ATTRIBUTES<p class="paragraph"/>   def config = SpringSecurityUtils.securityConfig<p class="paragraph"/>   def savedRequest = session&#91;DefaultSavedRequest.SPRING_SECURITY_SAVED_REQUEST_KEY&#93;
   <span class="java&#45;keyword">if</span> (savedRequest &#38;&#38; !config.successHandler.alwaysUseDefault) &#123;
      redirect url: savedRequest.redirectUrl
   &#125;
   <span class="java&#45;keyword">else</span> &#123;
      redirect uri: config.successHandler.defaultTargetUrl
   &#125;
&#125;</pre></div><p class="paragraph"/>You'll need to add these imports:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> org.codehaus.groovy.grails.plugins.springsecurity.GrailsUser
<span class="java&#45;keyword">import</span> org.springframework.security.core.authority.GrantedAuthorityImpl
<span class="java&#45;keyword">import</span> org.springframework.security.core.context.SecurityContextHolder as SCH</pre></div><p class="paragraph"/>To test this, add a new action to the secure controller that requires the virtual <code>ROLE_OPENID</code> role:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> openidtest<p class="paragraph"/><span class="java&#45;keyword">import</span> grails.plugins.springsecurity.Secured<p class="paragraph"/>class SecureController &#123;<p class="paragraph"/>   @Secured(&#91;'ROLE_ADMIN'&#93;)
   def admins = &#123;
      render 'Logged in with ROLE_ADMIN'
   &#125;<p class="paragraph"/>   @Secured(&#91;'ROLE_USER'&#93;)
   def users = &#123;
      render 'Logged in with ROLE_USER'
   &#125;<p class="paragraph"/>   @Secured(&#91;'ROLE_OPENID'&#93;)
   def openid = &#123;
      render 'Logged in with ROLE_OPENID'
   &#125;
&#125;</pre></div><p class="paragraph"/>Then start the server with <code>grails run-app</code> and navigate to <a href="http://localhost:8080/openidtest/secure/openid" target="blank">http://localhost:8080/openidtest/secure/openid</a>, and login using any OpenID. Once you authenticate and get redirected back to your application you should see the text <code>Logged in with ROLE_OPENID</code> indicating that you're logged in as a basic OpenID user.<p class="paragraph"/>Note that since this is a fake role, there's no need to store it in the database since real application users will never be granted ROLE_OPENID.

    
<script type="text/javascript">
	var _gaq = _gaq || [];
	_gaq.push(['_setAccount', 'UA-16219500-1']);
	_gaq.push(['_trackPageview']);

	(function() {
		var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	})();
</script>
</body>
</html>
