<html>
    <head>
        <meta http-equiv="Content-type" content="text/html; charset=utf-8"/>
        <title>3.1 User registration and linking</title>
        <link rel="stylesheet" href="../css/main.css" type="text/css" media="screen" title="Ref" charset="utf-8"/>
    </head>
    <body class="body">
    In this tutorial we'll cover
<ul class="star">
<li>creating a sample application</li>
<li>installing the plugin</li>
<li>configuring the plugin</li>
<li>using the account linking workflow</li>
<li>using the registration workflow</li>
</ul><p class="paragraph"/>First, create a new application:<p class="paragraph"/><pre class="bq"><code>
$ grails create-app openidtest
$ cd openidtest</code></pre><p class="paragraph"/>Install the OpenID plugin:
<pre class="bq"><code>
$ grails install-plugin spring-security-openid</code></pre><p class="paragraph"/>This will also install the Spring Security Core plugin since it's a dependency of this one.<p class="paragraph"/>Run the <code>s2-quickstart script</code> to initialize the core plugin:
<pre class="bq"><code>
$ grails s2-quickstart com.openidtest User Role</code></pre><p class="paragraph"/>Run the <code>s2-init-openid</code> script to initialize the OpenID plugin:
<pre class="bq"><code>
$ grails s2-init-openid</code></pre><p class="paragraph"/>To support the remember-me checkbox, run the <code>s2-create-persistent-token</code> script to generate a domain class for persistent tokens:<p class="paragraph"/><pre class="bq"><code>
$ grails s2-create-persistent-token com.openidtest.PersistentLogin</code></pre><p class="paragraph"/>To support linking one or more OpenIDs with local accounts, we need to create an <code>OpenID</code> domain class:<p class="paragraph"/><pre class="bq"><code>
$ grails s2-create-openid com.openidtest.OpenID</code></pre><p class="paragraph"/>and edit the generated user class and add a <code>hasMany</code> for an <code>openIds</code> property:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> com.openidtest<p class="paragraph"/>class User &#123;<p class="paragraph"/>   <span class="java&#45;object">String</span> username
   <span class="java&#45;object">String</span> password
   <span class="java&#45;object">boolean</span> enabled
   <span class="java&#45;object">boolean</span> accountExpired
   <span class="java&#45;object">boolean</span> accountLocked
   <span class="java&#45;object">boolean</span> passwordExpired<p class="paragraph"/>   <span class="java&#45;keyword">static</span> hasMany = &#91;openIds: OpenID&#93;<p class="paragraph"/>   <span class="java&#45;keyword">static</span> constraints = &#123;
      username blank: <span class="java&#45;keyword">false</span>, unique: <span class="java&#45;keyword">true</span>
      password blank: <span class="java&#45;keyword">false</span>
   &#125;<p class="paragraph"/>   <span class="java&#45;keyword">static</span> mapping = &#123;
      password column: '`password`'
   &#125;<p class="paragraph"/>   Set&#60;Role&#62; getAuthorities() &#123;
      UserRole.findAllByUser(<span class="java&#45;keyword">this</span>).collect &#123; it.role &#125; as Set
   &#125;
&#125;</pre></div><p class="paragraph"/>Now create some test users and grant them some roles in <code>grails-app/conf/BootStrap.groovy</code>:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">import</span> com.openidtest.Role
<span class="java&#45;keyword">import</span> com.openidtest.User
<span class="java&#45;keyword">import</span> com.openidtest.UserRole<p class="paragraph"/>class BootStrap &#123;<p class="paragraph"/>   def springSecurityService<p class="paragraph"/>   def init = &#123; servletContext &#45;&#62;
      <span class="java&#45;object">String</span> password = springSecurityService.encodePassword('password')<p class="paragraph"/>      def roleAdmin = <span class="java&#45;keyword">new</span> Role(authority: 'ROLE_ADMIN').save()
      def roleUser = <span class="java&#45;keyword">new</span> Role(authority: 'ROLE_USER').save()<p class="paragraph"/>      def user = <span class="java&#45;keyword">new</span> User(username: 'user', password: password, enabled: <span class="java&#45;keyword">true</span>).save()
      def admin = <span class="java&#45;keyword">new</span> User(username: 'admin', password: password, enabled: <span class="java&#45;keyword">true</span>).save()<p class="paragraph"/>      UserRole.create user, roleUser
      UserRole.create admin, roleUser
      UserRole.create admin, roleAdmin, <span class="java&#45;keyword">true</span>
   &#125;
&#125;</pre></div><p class="paragraph"/>The <code>s2-init-openid</code> script creates an <code>OpenIdController</code> but it'll be more natural to access its <code>createAccount</code> action under /login/ and we also want to use this controllers <code>auth</code> action instead of the core plugin's <code>LoginController.auth</code> since this one supports both OpenID and regular username/password logins, so add mappings in <code>grails-app/conf/UrlMappings.groovy</code> to support these changes:<p class="paragraph"/><div class="code"><pre>class UrlMappings &#123;<p class="paragraph"/>   <span class="java&#45;keyword">static</span> mappings = &#123;<p class="paragraph"/>      <span class="java&#45;quote">"/login/auth"</span> &#123;
         controller = 'openId'
         action = 'auth'
      &#125;
      <span class="java&#45;quote">"/login/openIdCreateAccount"</span> &#123;
         controller = 'openId'
         action = 'createAccount'
      &#125;<p class="paragraph"/>      <span class="java&#45;quote">"/$controller/$action?/$id?"</span>&#123;
         constraints &#123;
            // apply constraints here
         &#125;
      &#125;
      <span class="java&#45;quote">"/"</span>(view:<span class="java&#45;quote">"/index"</span>)
      <span class="java&#45;quote">"500"</span>(view:'/error')
   &#125;
&#125;</pre></div><p class="paragraph"/>Now create a controller that's secured with annotations for testing:<p class="paragraph"/><pre class="bq"><code>
$ grails create-controller secure</code></pre><p class="paragraph"/>and add this code:<p class="paragraph"/><div class="code"><pre><span class="java&#45;keyword">package</span> openidtest<p class="paragraph"/><span class="java&#45;keyword">import</span> grails.plugins.springsecurity.Secured<p class="paragraph"/>class SecureController &#123;<p class="paragraph"/>   @Secured(&#91;'ROLE_ADMIN'&#93;)
   def admins = &#123;
      render 'Logged in with ROLE_ADMIN'
   &#125;<p class="paragraph"/>   @Secured(&#91;'ROLE_USER'&#93;)
   def users = &#123;
      render 'Logged in with ROLE_USER'
   &#125;
&#125;</pre></div><p class="paragraph"/>and finally we're ready to run the app:<p class="paragraph"/><pre class="bq"><code>
$ grails run-app</code></pre><p class="paragraph"/>Navigate to <a href="http://localhost:8080/openidtest/secure/admins" target="blank">http://localhost:8080/openidtest/secure/admins</a> and you should be prompted with the login screen. Leave the Use OpenID checkbox checked and enter a valid OpenID. Don't check the remember-me checkbox yet (it doesn't work with the extended workflows where you create a new user or link an OpenID) and click the "Log in" button.<p class="paragraph"/>After authenticating at the OpenID provider, you'll be redirected to the registration page. Note that there's a link to just associate the current OpenID with a local account - for now click the "link this OpenID" link.<p class="paragraph"/>At the next screen enter the username and password for the user we created in BootStrap with ROLE_ADMIN ('admin'/'password') and you will be redirected to <a href="http://localhost:8080/openidtest/secure/admins" target="blank">http://localhost:8080/openidtest/secure/admins</a><p class="paragraph"/>To test that the OpenID is linked to your account, logout by navigating to <a href="http://localhost:8080/openidtest/logout/" target="blank">http://localhost:8080/openidtest/logout/</a> and navigate to <a href="http://localhost:8080/openidtest/secure/admins" target="blank">http://localhost:8080/openidtest/secure/admins</a>. Logging out removes the remember-me cookie, so authenticate again with your OpenID (this time check the remember-me checkbox) and it should skip the register/link step and go directly to the secured page. You can also repeat the process and switch to the username/password login and use that.<p class="paragraph"/>To test remember-me, close the browser and re-open it, and navigate to <a href="http://localhost:8080/openidtest/secure/admins" target="blank">http://localhost:8080/openidtest/secure/admins</a>. It should skip the authentication step entirely and show the page.<p class="paragraph"/><h4>User Registration</h4><p class="paragraph"/>Now let's create a new user associated with an OpenID. Logout again and navigate to <a href="http://localhost:8080/openidtest/secure/users" target="blank">http://localhost:8080/openidtest/secure/users</a> to initiate a login for a resource that requires ROLE_USER.<p class="paragraph"/>Since you've already associated the previous OpenID with a user, you either need to use a second OpenID, or restart the application to clear out the in-memory database.<p class="paragraph"/>Login using either the new OpenID or the original after restarting, and after authenticating externally you'll be redirected to the registration page. This time create a new user. By default the password validation rules are rather strict and you can change them, but for now enter a password that's at least 8 characters and contains at least one number and at least one symbol (e.g. !, #, $, %, etc.)<p class="paragraph"/>You should be redirected to <a href="http://localhost:8080/openidtest/secure/users" target="blank">http://localhost:8080/openidtest/secure/users</a> after creating the account. Now logout and log back in, both with the username/password for the account you created and the OpenID you linked and both should work.<p class="paragraph"/>
    
<script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script>
<script type="text/javascript">
try{
var pageTracker = _gat._getTracker('UA-16219500-1');
pageTracker._trackPageview();
} catch(err) {}
</script>
</body>
</html>
