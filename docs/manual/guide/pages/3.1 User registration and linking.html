<html><head><meta content='text/html; charset=utf-8' http-equiv='Content-type'></meta><title>3.1 User registration and linking</title><link title='Ref' charset='utf-8' rel='stylesheet' type='text/css' href='../css/main.css' media='screen'></link></head><body><body class='body'>
    In this tutorial we'll cover
<ul class='star'><li>creating a sample application</li><li>installing the plugin</li><li>configuring the plugin</li><li>using the account linking workflow</li><li>using the registration workflow</li></ul><p class='paragraph'></p>First, create a new application:<p class='paragraph'></p><pre class='bq'><code>
$ grails create-app openidtest
$ cd openidtest</code></pre><p class='paragraph'></p>Install the OpenID plugin:
<pre class='bq'><code>
$ grails install-plugin spring-security-openid</code></pre><p class='paragraph'></p>This will also install the Spring Security Core plugin since it's a dependency of this one.<p class='paragraph'></p>Run the <code>s2-quickstart script</code> to initialize the core plugin:
<pre class='bq'><code>
$ grails s2-quickstart com.openidtest User Role</code></pre><p class='paragraph'></p>Run the <code>s2-init-openid</code> script to initialize the OpenID plugin:
<pre class='bq'><code>
$ grails s2-init-openid</code></pre><p class='paragraph'></p>To support the remember-me checkbox, run the <code>s2-create-persistent-token</code> script to generate a domain class for persistent tokens:<p class='paragraph'></p><pre class='bq'><code>
$ grails s2-create-persistent-token com.openidtest.PersistentLogin</code></pre><p class='paragraph'></p>To support linking one or more OpenIDs with local accounts, we need to create an <code>OpenID</code> domain class:<p class='paragraph'></p><pre class='bq'><code>
$ grails s2-create-openid com.openidtest.OpenID</code></pre><p class='paragraph'></p>and edit the generated user class and add a <code>hasMany</code> for an <code>openIds</code> property:<p class='paragraph'></p><div class='code'><pre><span class='java-keyword'>package</span> com.openidtest<p class='paragraph'></p>class User {<p class='paragraph'></p><span class='java-object'>String</span> username
   <span class='java-object'>String</span> password
   <span class='java-object'>boolean</span> enabled
   <span class='java-object'>boolean</span> accountExpired
   <span class='java-object'>boolean</span> accountLocked
   <span class='java-object'>boolean</span> passwordExpired<p class='paragraph'></p><span class='java-keyword'>static</span> hasMany = [openIds: OpenID]<p class='paragraph'></p><span class='java-keyword'>static</span> constraints = {
      username blank: <span class='java-keyword'>false</span>, unique: <span class='java-keyword'>true</span>
      password blank: <span class='java-keyword'>false</span>
   }<p class='paragraph'></p><span class='java-keyword'>static</span> mapping = {
      password column: '`password`'
   }<p class='paragraph'></p>   Set&lt;Role&gt; getAuthorities() {
      UserRole.findAllByUser(<span class='java-keyword'>this</span>).collect { it.role } as Set
   }
}</pre></div><p class='paragraph'></p>Now create some test users and grant them some roles in <code>grails-app/conf/BootStrap.groovy</code>:<p class='paragraph'></p><div class='code'><pre><span class='java-keyword'>import</span> com.openidtest.Role
<span class='java-keyword'>import</span> com.openidtest.User
<span class='java-keyword'>import</span> com.openidtest.UserRole<p class='paragraph'></p>class BootStrap {<p class='paragraph'></p>   def springSecurityService<p class='paragraph'></p>   def init = { servletContext -&gt;
      <span class='java-object'>String</span> password = springSecurityService.encodePassword('password')<p class='paragraph'></p>      def roleAdmin = <span class='java-keyword'>new</span> Role(authority: 'ROLE_ADMIN').save()
      def roleUser = <span class='java-keyword'>new</span> Role(authority: 'ROLE_USER').save()<p class='paragraph'></p>      def user = <span class='java-keyword'>new</span> User(username: 'user', password: password, enabled: <span class='java-keyword'>true</span>).save()
      def admin = <span class='java-keyword'>new</span> User(username: 'admin', password: password, enabled: <span class='java-keyword'>true</span>).save()<p class='paragraph'></p>      UserRole.create user, roleUser
      UserRole.create admin, roleUser
      UserRole.create admin, roleAdmin, <span class='java-keyword'>true</span>
   }
}</pre></div><p class='paragraph'></p>The <code>s2-init-openid</code> script creates an <code>OpenIdController</code> but it'll be more natural to access its <code>createAccount</code> action under /login/ and we also want to use this controllers <code>auth</code> action instead of the core plugin's <code>LoginController.auth</code> since this one supports both OpenID and regular username/password logins, so add mappings in <code>grails-app/conf/UrlMappings.groovy</code> to support these changes:<p class='paragraph'></p><div class='code'><pre>class UrlMappings {<p class='paragraph'></p><span class='java-keyword'>static</span> mappings = {<p class='paragraph'></p><span class='java-quote'>"/login/auth"</span> {
         controller = 'openId'
         action = 'auth'
      }
      <span class='java-quote'>"/login/openIdCreateAccount"</span> {
         controller = 'openId'
         action = 'createAccount'
      }<p class='paragraph'></p><span class='java-quote'>"/$controller/$action?/$id?"</span>{
         constraints {
            // apply constraints here
         }
      }
      <span class='java-quote'>"/"</span>(view:<span class='java-quote'>"/index"</span>)
      <span class='java-quote'>"500"</span>(view:'/error')
   }
}</pre></div><p class='paragraph'></p>Now create a controller that's secured with annotations for testing:<p class='paragraph'></p><pre class='bq'><code>
$ grails create-controller secure</code></pre><p class='paragraph'></p>and add this code:<p class='paragraph'></p><div class='code'><pre><span class='java-keyword'>package</span> openidtest<p class='paragraph'></p><span class='java-keyword'>import</span> grails.plugins.springsecurity.Secured<p class='paragraph'></p>class SecureController {<p class='paragraph'></p>   @Secured(['ROLE_ADMIN'])
   def admins = {
      render 'Logged in with ROLE_ADMIN'
   }<p class='paragraph'></p>   @Secured(['ROLE_USER'])
   def users = {
      render 'Logged in with ROLE_USER'
   }
}</pre></div><p class='paragraph'></p>and finally we're ready to run the app:<p class='paragraph'></p><pre class='bq'><code>
$ grails run-app</code></pre><p class='paragraph'></p>Navigate to <a target='blank' href='http://localhost:8080/openidtest/secure/admins'>http://localhost:8080/openidtest/secure/admins</a> and you should be prompted with the login screen. Leave the Use OpenID checkbox checked and enter a valid OpenID. Don't check the remember-me checkbox yet (it doesn't work with the extended workflows where you create a new user or link an OpenID) and click the "Log in" button.<p class='paragraph'></p>After authenticating at the OpenID provider, you'll be redirected to the registration page. Note that there's a link to just associate the current OpenID with a local account - for now click the "link this OpenID" link.<p class='paragraph'></p>At the next screen enter the username and password for the user we created in BootStrap with ROLE_ADMIN ('admin'/'password') and you will be redirected to <a target='blank' href='http://localhost:8080/openidtest/secure/admins'>http://localhost:8080/openidtest/secure/admins</a><p class='paragraph'></p>To test that the OpenID is linked to your account, logout by navigating to <a target='blank' href='http://localhost:8080/openidtest/logout/'>http://localhost:8080/openidtest/logout/</a> and navigate to <a target='blank' href='http://localhost:8080/openidtest/secure/admins'>http://localhost:8080/openidtest/secure/admins</a>. Logging out removes the remember-me cookie, so authenticate again with your OpenID (this time check the remember-me checkbox) and it should skip the register/link step and go directly to the secured page. You can also repeat the process and switch to the username/password login and use that.<p class='paragraph'></p>To test remember-me, close the browser and re-open it, and navigate to <a target='blank' href='http://localhost:8080/openidtest/secure/admins'>http://localhost:8080/openidtest/secure/admins</a>. It should skip the authentication step entirely and show the page.<p class='paragraph'></p><h4>User Registration</h4><p class='paragraph'></p>Now let's create a new user associated with an OpenID. Logout again and navigate to <a target='blank' href='http://localhost:8080/openidtest/secure/users'>http://localhost:8080/openidtest/secure/users</a> to initiate a login for a resource that requires ROLE_USER.<p class='paragraph'></p>Since you've already associated the previous OpenID with a user, you either need to use a second OpenID, or restart the application to clear out the in-memory database.<p class='paragraph'></p>Login using either the new OpenID or the original after restarting, and after authenticating externally you'll be redirected to the registration page. This time create a new user. By default the password validation rules are rather strict and you can change them, but for now enter a password that's at least 8 characters and contains at least one number and at least one symbol (e.g. !, #, $, %, etc.)<p class='paragraph'></p>You should be redirected to <a target='blank' href='http://localhost:8080/openidtest/secure/users'>http://localhost:8080/openidtest/secure/users</a> after creating the account. Now logout and log back in, both with the username/password for the account you created and the OpenID you linked and both should work.<p class='paragraph'></p>
<script type="text/javascript">
	var _gaq = _gaq || [];
	_gaq.push(['_setAccount', 'UA-16219500-1']);
	_gaq.push(['_trackPageview']);

	(function() {
		var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	})();
</script>
</body></html>